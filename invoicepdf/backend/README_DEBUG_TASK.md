# 任务调试指南

## 当前任务状态

**任务ID**: `0fd519c9-7716-42b2-8091-dae1cb3f535b`  
**文件名**: `China SY inv 1.PDF`  
**状态**: `processing`  
**开始时间**: `2026-01-27 14:58:10`  
**已运行时长**: 约4分钟  
**external_file_id**: `785ff157-160a-4436-b583-c3f4165ec7d9` ✅

## 问题分析

1. ✅ **文件存在**: 文件路径存在，大小133KB
2. ✅ **external_file_id存在**: 文件已上传到DIFY平台
3. ✅ **模型配置正确**: SYNTAX-AI-API_V2，端点 `http://8.145.33.61/v1`
4. ❌ **DIFY平台无调用记录**: 说明API请求未到达DIFY平台
5. ⚠️ **任务卡在processing**: 已运行4分钟未完成

## 可能的原因

### 1. process_task方法未执行到API调用
- 可能在文件检查、模型配置获取等步骤卡住
- 查看日志中是否有 `[步骤1]` 到 `[步骤7]` 的输出

### 2. API调用前发生异常但未记录
- 检查是否有异常被捕获但未正确记录
- 查看应用控制台日志

### 3. 同步执行导致超时
- `process_task` 是同步执行的，如果API调用超时（300秒），任务会卡住
- 但4分钟应该还没到超时时间

## 查看日志的方法

### 方法1: 查看应用控制台日志（推荐）

应用使用 `uvicorn` 启动，日志输出到控制台。请查看运行后端的终端窗口，查找以下日志：

```
=== 开始处理识别任务: 0fd519c9-7716-42b2-8091-dae1cb3f535b ===
[步骤1] 获取任务对象
[步骤2] 获取模型配置ID
[步骤3] 查询模型配置对象
[步骤4] 获取票据信息
[步骤5] 获取文件信息
[步骤6] 检查文件路径
[步骤7] 准备调用API
[步骤C] 构建识别API请求
[步骤D] 准备发送HTTP请求
```

### 方法2: 查看debug.log文件

```powershell
# 查看最近的debug日志
Get-Content invoicepdf\.cursor\debug.log -Tail 50 -Encoding UTF8
```

### 方法3: 使用检查脚本

```powershell
# 检查任务详情
python check_task_logs.py 0fd519c9-7716-42b2-8091-dae1cb3f535b

# 检查最近的任务
python check_recent_tasks.py
```

## 调试步骤

### 步骤1: 检查应用日志

查看运行后端的终端窗口，确认是否有以下日志：

1. **任务启动日志**:
   ```
   === 准备调用 SYNTAX 服务 ===
   任务ID: 0fd519c9-7716-42b2-8091-dae1cb3f535b
   开始调用 process_task...
   ```

2. **process_task执行日志**:
   ```
   === 开始处理识别任务: 0fd519c9-7716-42b2-8091-dae1cb3f535b ===
   [步骤1] 获取任务对象
   [步骤2] 获取模型配置ID
   ...
   ```

3. **API调用日志**:
   ```
   [步骤C] 构建识别API请求
   [步骤D] 准备发送HTTP请求
   [步骤D4] 执行 client.post()...
   ```

### 步骤2: 如果日志中没有 `[步骤1]` 等标记

说明 `process_task` 方法根本没有被调用，或者调用时发生了异常。检查：
- 是否有异常堆栈信息
- `start_recognition` 函数是否正常返回

### 步骤3: 如果日志中有 `[步骤1]` 但没有 `[步骤C]`

说明执行到了 `process_task`，但在调用API之前卡住了。检查：
- 是否有 `[步骤7]` 日志（准备调用API）
- 是否有任何错误信息

### 步骤4: 如果日志中有 `[步骤D4]` 但没有响应

说明HTTP请求已发送，但可能：
- 网络问题导致请求未到达DIFY平台
- DIFY平台响应超时
- 请求被防火墙或代理拦截

## 立即检查

请提供以下信息：

1. **应用控制台日志**: 复制运行后端的终端窗口中的日志（特别是包含 `[步骤X]` 的部分）

2. **是否有错误信息**: 查看是否有任何异常或错误日志

3. **网络连接**: 确认服务器能否访问 `http://8.145.33.61/v1`

## 快速测试

使用测试脚本直接调用API，验证网络和配置：

```powershell
python test_api_call_directly.py "China SY inv 1.PDF"
```

如果测试脚本成功但实际应用失败，说明问题在应用代码逻辑中。

