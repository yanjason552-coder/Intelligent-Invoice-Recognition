# 发票识别详细测试指南

## 测试脚本说明

`test_invoice_recognition_detailed.py` 是一个详细的测试脚本，用于追踪发票识别流程的每一步，帮助定位卡住的具体位置。

## 使用方法

### 基本用法

```powershell
cd invoicepdf\backend
python test_invoice_recognition_detailed.py
```

### 指定文件名

```powershell
python test_invoice_recognition_detailed.py "China SY inv 1.PDF"
```

## 测试步骤说明

脚本会按顺序执行以下步骤，每个步骤都会记录详细信息和时间戳：

1. **连接数据库** - 建立数据库连接
2. **查找文件记录** - 在 `invoice_file` 表中查找文件
3. **检查本地文件** - 验证文件是否存在于磁盘
4. **查找发票记录** - 查找关联的发票记录
5. **查找识别任务** - 查找最新的识别任务
6. **检查任务参数** - 验证任务参数是否完整
7. **查找模型配置** - 获取 LLM 配置信息
8. **检查API配置** - 验证 endpoint 和 api_key
9. **检查external_file_id** - 检查文件是否有外部文件ID
10. **检查任务状态** - 查看当前任务状态
11. **启动识别任务** - 如果状态为pending，更新为processing
12. **调用识别服务** - 执行实际的识别处理

## 输出说明

### 控制台输出

脚本会在控制台实时输出每个步骤的执行情况：

```
[2024-01-01 12:00:00.123] ▶ 步骤 1: 连接数据库
    message: 数据库连接成功

[2024-01-01 12:00:00.456] ✓ 步骤 2: 查找文件记录
    file_id: xxx-xxx-xxx
    file_name: China SY inv 1.PDF
    ...
```

### 日志文件

所有详细信息会保存到 `recognition_test_log.txt` 文件中，格式为 JSON Lines（每行一个JSON对象），便于后续分析。

## 常见问题定位

### 1. 卡在"连接数据库"
- **原因**: 数据库服务未启动或连接信息错误
- **解决**: 检查数据库连接配置

### 2. 卡在"查找文件记录"
- **原因**: 文件未上传或文件名不匹配
- **解决**: 确认文件已上传，检查文件名是否完全一致

### 3. 卡在"检查本地文件"
- **原因**: 文件路径错误或文件被删除
- **解决**: 检查文件路径，确认文件存在

### 4. 卡在"查找模型配置"
- **原因**: 模型配置不存在或未启用
- **解决**: 检查 `llm_config` 表，确保配置存在且 `is_active = true`

### 5. 卡在"检查API配置"
- **原因**: endpoint 或 api_key 未配置
- **解决**: 检查模型配置的 endpoint 和 api_key 字段

### 6. 卡在"调用识别服务"
- **原因**: API调用失败、超时或网络问题
- **解决**: 
  - 查看详细日志中的错误信息
  - 检查网络连接
  - 验证 API endpoint 是否可访问
  - 检查 API key 是否有效

## 日志分析

### 查看日志文件

```powershell
# 查看完整日志
Get-Content recognition_test_log.txt

# 只查看失败的步骤
Get-Content recognition_test_log.txt | ConvertFrom-Json | Where-Object { $_.status -eq "failed" }
```

### 日志格式

每个日志条目包含：
- `timestamp`: 时间戳
- `step`: 步骤编号
- `step_name`: 步骤名称
- `status`: 状态（start/success/failed/info）
- `details`: 详细信息（字典）
- `error`: 错误信息（如果有）

## 与后端日志结合

测试脚本的输出会与后端服务的日志（`dify_service.py`）结合，提供完整的追踪信息。

后端日志中每个步骤都有明确的标记：
- `[步骤1]` - 获取任务对象
- `[步骤2]` - 获取模型配置ID
- `[步骤3]` - 查询模型配置对象
- `[步骤4]` - 获取票据信息
- `[步骤5]` - 获取文件信息
- `[步骤6]` - 检查文件路径
- `[步骤7]` - 准备调用API
- `[步骤8]` - API调用结果
- `[步骤9]` - 保存识别结果
- `[步骤10]` - 标记任务完成

## 示例输出

```
================================================================================
发票识别详细测试
================================================================================
测试文件: China SY inv 1.PDF
日志文件: recognition_test_log.txt
================================================================================

[2024-01-01 12:00:00.123] ▶ 步骤 1: 连接数据库
    message: 数据库连接成功

[2024-01-01 12:00:00.456] ✓ 步骤 2: 查找文件记录
    file_id: 2c448775-1fc4-48c3-a3f3-c7463f5c494a
    file_name: China SY inv 1.PDF
    file_path: uploads/invoices/xxx.pdf
    external_file_id: 未设置

...

[2024-01-01 12:00:05.789] ✓ 步骤 12: 调用识别服务
    result: 成功
    elapsed_time_seconds: 3.45

================================================================================
测试完成
================================================================================
详细日志已保存到: recognition_test_log.txt
```

## 注意事项

1. 确保后端服务已启动（如果需要）
2. 确保数据库连接正常
3. 确保文件已上传到系统
4. 确保模型配置已正确设置
5. 如果任务卡在 processing 状态，脚本会显示持续时间

