# 快速测试指南 - 发票识别卡住问题诊断

## 当前状态

根据测试结果，文件 "China SY inv 1.PDF" 已找到，但**未找到识别任务**。

## 测试结果摘要

✅ **文件记录**: 已找到
- 文件ID: `b526e0b4-703b-40f0-bf52-2ab0f8fd765b`
- 文件路径: `uploads/invoices/e31fc123-e56d-40db-994f-24920db3bb1c.PDF`
- 文件大小: 133,281 字节
- 状态: uploaded
- ⚠️ **external_file_id**: 未设置

✅ **发票记录**: 已找到
- 发票ID: `8f372b02-37d0-435a-8309-4991ec2cd295`
- 发票编号: `INV-20260127141310-4c7bd627`
- 识别状态: `pending`
- 审核状态: `pending`

❌ **识别任务**: 未找到
- 需要先创建识别任务

## 下一步操作

### 1. 创建识别任务

在前端界面：
1. 找到发票 "China SY inv 1.PDF"
2. 选择该发票
3. 点击"创建识别任务"或"批量创建任务"
4. 选择模型配置（确保配置正确）
5. 选择识别方式
6. 创建任务

### 2. 启动识别任务

创建任务后：
1. 点击"启动识别"按钮
2. 观察任务状态变化
3. 如果卡在"识别中"，运行测试脚本查看详细信息

### 3. 运行详细测试

创建并启动任务后，运行测试脚本：

```powershell
cd invoicepdf\invoicepdf\backend
python test_invoice_recognition_standalone.py "China SY inv 1.PDF"
```

## 如果任务卡在"识别中"

测试脚本会显示：
- 任务卡住的持续时间
- 错误代码和错误消息
- 模型配置信息
- API配置状态
- 文件external_file_id状态

## 常见问题

### 问题1: 文件缺少 external_file_id

**现象**: `external_file_id: 未设置`

**影响**: 系统会在识别时自动上传文件到外部API

**解决**: 
- 如果自动上传失败，会返回错误代码 `EXTERNAL_UPLOAD_FAILED`
- 检查 API endpoint 和 key 是否正确
- 检查网络连接

### 问题2: 任务卡在 processing 状态

**可能原因**:
1. API调用超时（默认5分钟）
2. 文件自动上传失败
3. API endpoint不可访问
4. API key无效
5. 网络问题

**诊断步骤**:
1. 运行测试脚本查看详细信息
2. 查看后端日志（查找 `[步骤7]` 到 `[步骤10]`）
3. 检查任务错误代码和错误消息

## 测试脚本输出示例

```
[2026-01-27 14:31:54.868] ✗ 步骤 6: 查找识别任务
    error: 未找到识别任务

[错误] 未找到识别任务
请先创建识别任务

提示:
1. 在前端界面选择此发票
2. 点击'创建识别任务'或'批量创建任务'
3. 选择模型配置和识别方式
4. 创建任务后，点击'启动识别'
```

## 数据库信息

- **数据库**: `app` (不是 `ruoyi_db`)
- **服务器**: 219.151.188.129:50510
- **文件已找到**: ✓
- **发票已找到**: ✓
- **任务未找到**: ✗

