# 销售订单导入功能说明

## 功能概述

在"销售订单-显示"页面，点击工具栏中的"导入"按钮，可以弹出文件选择对话框，允许用户选择Excel文件，将文件中的内容导入到数据库中。

## 功能特点

### 1. 文件格式支持
- **支持格式**: `.xlsx` 和 `.xls` 文件
- **文件结构**: 
  - 第1行：字段名（英文）
  - 第2行：字段注释（中文）
  - 第3行开始：数据内容

### 2. 数据验证
- **必要字段检查**: 确保 `doc_id`、`doc_no`、`sequence` 字段存在
- **数据类型转换**: 自动转换日期和数值字段
- **数据清理**: 跳过无效行，只导入有效数据

### 3. 用户界面
- **文件选择**: 点击导入按钮自动弹出文件选择对话框
- **导入状态**: 显示"导入中..."状态，防止重复操作
- **结果反馈**: 显示导入成功/失败的详细信息

## 使用方法

### 1. 准备Excel文件
确保Excel文件格式正确：
```
第1行: sales_order_doc_d_id | customer_full_name | doc_id | doc_no | sequence | ...
第2行: 物理主键            | 客户全名           | 订单类型 | 订单单号 | 订单行号 | ...
第3行: TEST001             | 测试客户1          | SO001   | 2024001 | 0010     | ...
第4行: TEST002             | 测试客户2          | SO002   | 2024002 | 0020     | ...
...
```

### 2. 执行导入
1. 打开"销售订单-显示"页面
2. 点击工具栏中的"导入"按钮（橙色上传图标）
3. 在弹出的文件选择对话框中选择Excel文件
4. 系统自动读取、验证并导入数据
5. 查看导入结果提示

## 字段映射

| Excel列 | 字段名 | 说明 | 是否必填 |
|---------|--------|------|----------|
| A | sales_order_doc_d_id | 物理主键 | 否（自动生成） |
| B | customer_full_name | 客户全名 | 否 |
| C | doc_id | 订单类型 | 是 |
| D | doc_no | 订单单号 | 是 |
| E | sequence | 订单行号 | 是 |
| F | doc_date | 订单日期 | 否 |
| G | material_id | 物料主键 | 否 |
| H | material_code | 物料编码 | 否 |
| I | material_description | 物料描述 | 否 |
| J | material_specification | 物料规格 | 否 |
| K | material_type_id | 材质主键 | 否 |
| L | material_type_code | 材质编码 | 否 |
| M | dimensions_desc | 规格 | 否 |
| N | actual_thickness | 实际厚度 | 否 |
| O | surface_code_combination | 表面代码(组合) | 否 |
| P | surface_desc_combination | 表面描述(组合) | 否 |
| Q | inside_film_desc | 里层膜 | 否 |
| R | outside_film_desc | 外层膜 | 否 |
| S | opposite_film_desc | 反面膜 | 否 |
| T | qty | 订单数量 | 否 |
| U | unit_id | 订单单位 | 否 |
| V | delivery_date | 交期 | 否 |
| W | nestinged_qty | 已套料数量 | 否 |
| X | creator | 创建人 | 否（自动设置） |
| Y | create_date | 创建日期 | 否（自动设置） |
| Z | modifier_last | 最后修改人 | 否 |
| AA | modify_date_last | 最后修改日期 | 否 |
| AB | approve_status | 审批状态 | 否（默认"0"） |
| AC | approver | 审批人 | 否 |
| AD | approve_date | 审批日期 | 否 |

## 数据处理规则

### 1. 自动字段
- **sales_order_doc_d_id**: 如果为空，系统会自动生成UUID
- **creator**: 如果为空，自动设置为当前登录用户
- **create_date**: 如果为空，自动设置为当前时间
- **approve_status**: 如果为空，默认设置为"0"（待审批）

### 2. 数据类型转换
- **日期字段**: 自动转换为ISO格式
- **数值字段**: 自动转换为浮点数
- **字符串字段**: 保持原样

### 3. 业务规则
- **业务主键唯一性**: `doc_id` + `doc_no` + `sequence` 组合必须唯一
- **重复数据处理**: 如果记录已存在，会跳过该记录并记录在失败列表中

## 错误处理

### 1. 文件格式错误
- **错误**: 选择了非Excel文件
- **处理**: 显示"请选择Excel文件 (.xlsx 或 .xls)"提示

### 2. 数据格式错误
- **错误**: 缺少必要字段
- **处理**: 跳过该行，继续处理其他行

### 3. 业务规则错误
- **错误**: 业务主键重复
- **处理**: 跳过重复记录，记录在失败列表中

### 4. 网络错误
- **错误**: API调用失败
- **处理**: 显示具体错误信息

## 测试

### 1. 生成测试文件
```bash
cd backend
python create_test_excel.py
```

### 2. 测试导入功能
1. 运行生成的 `test_sales_order_import.xlsx` 文件
2. 在"销售订单-显示"页面点击导入按钮
3. 选择测试文件进行导入
4. 验证导入结果

## 技术实现

### 1. 前端实现
- **文件读取**: 使用 `xlsx` 库读取Excel文件
- **数据验证**: 前端进行基础数据验证
- **API调用**: 调用统一API接口进行批量导入

### 2. 后端实现
- **统一接口**: 使用 `/api/v1/salesOrderDocD/unified` 接口
- **批量处理**: 支持批量创建操作
- **事务处理**: 确保数据一致性

### 3. 数据流程
```
用户选择文件 → 前端读取Excel → 数据验证 → 调用API → 后端批量导入 → 返回结果
```

## 注意事项

1. **文件大小**: 建议单次导入不超过100条记录
2. **数据格式**: 确保Excel文件格式正确，特别是日期格式
3. **网络环境**: 导入过程中保持网络连接稳定
4. **权限要求**: 需要登录用户权限
5. **数据备份**: 建议在导入前备份重要数据 