# 删除功能说明

## 功能概述

删除功能允许用户选择表格中的记录并批量删除，支持单条或多条记录删除，删除后会自动更新表格显示。

## 功能特点

### 1. 选择删除
- **单条删除**: 选择一条记录进行删除
- **批量删除**: 选择多条记录进行批量删除
- **全选删除**: 选择所有记录进行删除

### 2. 安全确认
- **确认对话框**: 删除前显示确认对话框
- **数量提示**: 显示要删除的记录数量
- **操作确认**: 用户必须确认才能执行删除

### 3. 实时反馈
- **进度显示**: 删除过程中显示加载状态
- **结果提示**: 删除完成后显示成功/失败提示
- **表格更新**: 删除后自动从表格中移除记录

## 使用方法

### 1. 选择记录
1. 在表格中勾选要删除的记录
2. 可以使用全选复选框选择所有记录
3. 可以单独勾选特定记录

### 2. 执行删除
1. 点击工具栏中的"删除"按钮（🗑️图标）
2. 系统会检查是否有选中的记录
3. 显示确认对话框，显示要删除的记录数量
4. 点击"确定"执行删除，点击"取消"取消操作

### 3. 查看结果
1. 删除过程中表格显示加载状态
2. 删除完成后显示Toast提示信息
3. 成功删除的记录会从表格中移除
4. 选中状态会自动清空

## 技术实现

### 1. 前端逻辑
```typescript
const handleDelete = async () => {
  // 检查选中记录
  if (selectedRows.length === 0) {
    showErrorToast('请先选择要删除的记录')
    return
  }

  // 确认删除
  if (!confirm(`确定要删除选中的 ${selectedRows.length} 条记录吗？`)) {
    return
  }

  // 逐个删除记录
  for (const id of selectedRows) {
    await deleteRecord(id)
  }

  // 更新表格数据
  setTableData(prev => prev.filter(item => !selectedRows.includes(item.id)))
  setSelectedRows([])
}
```

### 2. API调用
```typescript
const response = await fetch('/api/v1/salesOrderDocD/unified', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    action: 'delete',
    module: 'sales_order_doc_d',
    data: { id: recordId },
    timestamp: new Date().toISOString()
  })
})
```

### 3. 后端处理
- 验证记录是否存在
- 检查删除权限
- 执行数据库删除操作
- 返回删除结果

## 错误处理

### 1. 前端错误
- **未选择记录**: 显示"请先选择要删除的记录"
- **网络错误**: 显示"删除操作失败，请重试"
- **权限错误**: 显示相应的权限错误信息

### 2. 后端错误
- **记录不存在**: 返回"记录不存在"错误
- **权限不足**: 返回"权限不足"错误
- **数据库错误**: 返回具体的数据库错误信息

### 3. 部分成功处理
- 统计成功和失败的删除数量
- 显示详细的成功/失败信息
- 只移除成功删除的记录

## 安全考虑

### 1. 权限验证
- 验证用户登录状态
- 检查用户删除权限
- 记录删除操作日志

### 2. 数据保护
- 删除前确认操作
- 防止误删除重要数据
- 支持数据恢复机制

### 3. 操作限制
- 已审批记录不能删除
- 重要记录需要特殊权限
- 批量删除数量限制

## 测试方法

### 1. 功能测试
```bash
# 后端API测试
cd backend
python test_delete_api.py

# 前端功能测试
# 在浏览器控制台运行
# frontend/test_delete_frontend.js
```

### 2. 测试场景
1. **单条删除**: 选择一条记录进行删除
2. **批量删除**: 选择多条记录进行删除
3. **全选删除**: 选择所有记录进行删除
4. **权限测试**: 测试不同权限用户的删除操作
5. **错误测试**: 测试各种错误情况

### 3. 验证要点
- 删除前确认对话框正常显示
- 删除过程中显示加载状态
- 删除后表格数据正确更新
- Toast提示信息正确显示
- 选中状态正确清空

## 性能优化

### 1. 批量处理
- 支持批量删除操作
- 减少API调用次数
- 提高删除效率

### 2. 异步处理
- 使用异步操作避免界面阻塞
- 显示删除进度
- 支持取消操作

### 3. 缓存更新
- 删除后更新本地缓存
- 避免重复查询
- 提高界面响应速度

## 注意事项

1. **数据备份**: 重要数据删除前建议备份
2. **权限管理**: 确保只有有权限的用户可以删除
3. **操作确认**: 删除操作不可逆，需要谨慎操作
4. **日志记录**: 删除操作应该记录详细日志
5. **数据一致性**: 删除后确保数据一致性

## 扩展功能

### 1. 软删除
- 支持软删除（标记删除而不是物理删除）
- 支持数据恢复功能
- 支持删除历史查询

### 2. 高级功能
- 支持删除条件筛选
- 支持删除结果导出
- 支持删除操作回滚

### 3. 批量操作
- 支持按条件批量删除
- 支持删除进度显示
- 支持删除操作暂停/恢复

## 相关文件

- `frontend/src/components/Items/SalesOrderDisplay.tsx`: 删除功能实现
- `frontend/test_delete_frontend.js`: 前端测试脚本
- `backend/test_delete_api.py`: 后端测试脚本
- `frontend/DELETE_FEATURE_README.md`: 本文档 